# back.test
#
# This exercises the SubsonicInBC that forms the upstream boundary for
# the simulation of the Back et al. nozzle.
#
# PJ, 2015-01-20 adapted from Back nozzle test

package require tcltest 2.0
namespace import ::tcltest::*
configure -verbose {start body error}

test prepare-gas-model {Prepare gas model.} -body {
    exec prep-gas ideal-air.inp ideal-air-gas-model.lua > LOGFILE_PREP_GAS
} -result {} -returnCodes {0}

test run-preprocessor {Run the preprocessing stage.} -body {
    exec e4shared --prep --job=cyl-sf > LOGFILE_PREP
} -result {} -returnCodes {0}

test run-simulation {Run the parallel simulation code.} -body {
    exec e4shared --run --job=cyl-sf --verbosity=1 --max-cpus=4 > LOGFILE_MAIN
} -result {} -returnCodes {0}

test number-of-steps {Iteration of the final block in a certain number of steps.} -body {
    set fp [open LOGFILE_MAIN r]
    set contents [read $fp]
    close $fp
    set final_steps 0
    foreach line [split $contents "\n"] {
	if {[string first "final-t=" $line] >= 0} {
	    set final_steps [lindex [split $line] 1]
	}
    }
    expr abs($final_steps - 5287) < 100
} -result {1}

test shock-position {Shock position and post-shock conditions.} -body {
    # With this shock-fitting simulation, we take the first point 
    # in the grid as (being close enough to) the position of the shock.
    # For a free stream Mach number of 7, Billig's correlation gives
    # delta/R = 0.4246.
    # Normal shock jump tables give p2/p1=57, T2/T1=10.47, M2=0.3974
    set x_ref -1.425
    set p_ref 5.7e6
    set T_ref 3141.0
    set Mach_ref 0.3974
    # Probe the solution near the centreline of the upstream boundary
    # and pull a few values from the line of data that is produced by e3post.
    if { [catch {exec e4shared --post --job=cyl-sf --tindx-plot=last --add-vars="mach" --probe=-1.425,0.0,0.0 } results] } {
        puts "postprocessing probe command failed"
        puts $results
	set rho 0
	set p 0
	set T 0
	set Mach 0
    } else {
	set line_of_data [string trim [lindex [split $results "\n"] 5]]
	# puts $line_of_data
	set items [split $line_of_data]
	set x_pos [lindex $items 0]; # remember that index starts at 0
	set p [lindex $items 8]
	set T [lindex $items 19]
	set Mach [lindex $items 20]
	# puts "x_pos=$x_pos p=$p T=$T Mach=$Mach"
    }
    # The differences with respect to the reference values should be small. 
    list [expr abs($x_pos - $x_ref) < 3.0e-2] \
    	 [expr abs($p - $p_ref)/$p_ref < 3.0e-2] \
    	 [expr abs($T - $T_ref)/$T_ref < 1.0e-2] \
    	 [expr abs($Mach - $Mach_ref)/$Mach_ref < 2e-2]
} -result {1 1 1 1}

cleanupTests
