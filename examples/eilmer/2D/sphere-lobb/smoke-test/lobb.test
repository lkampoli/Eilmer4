# lobb.test
#
# This exercises the nonequilibrium thermochemistry with the flow of
# reacting air over a cylinder.
#
# RJG, 2016-01-25

package require tcltest 2.0
namespace import ::tcltest::*
configure -verbose {start body error}

test prepare-gas-model {Prepare gas model.} -body {
    exec prep-gas air-5sp.inp air-5sp.lua > LOGFILE_PREP_GAS
} -result {} -returnCodes {0}

test prepare-chem-file {Prepare chemistry file.} -body {
    exec prep-chem air-5sp.lua GuptaEtAl-air-reactions.lua air-5sp-6r.lua > LOGFILE_PREP_CHEM
} -result {} -returnCodes {0}

test run-preprocessor {Run the preprocessing stage.} -body {
    exec e4shared --prep --job=lobb > LOGFILE_PREP
} -result {} -returnCodes {0}

test run-simulation {Run the parallel simulation code.} -body {
    exec e4shared --run --job=lobb --verbosity=1 --max-cpus=4 > LOGFILE_MAIN
} -result {} -returnCodes {0}

test number-of-steps {Iteration of the final block in a certain number of steps.} -body {
    set fp [open LOGFILE_MAIN r]
    set contents [read $fp]
    close $fp
    set final_steps 0
    foreach line [split $contents "\n"] {
	if {[string first "final-t=" $line] >= 0} {
	    set final_steps [lindex [split $line] 1]
	}
    }
    expr abs($final_steps - 19209) < 200
} -result {1}

test post-simulation {Extract the shock location.} -body {
    exec e4shared --job=lobb --custom-post --script-file=shock-detachment.lua > LOGFILE_POST
    catch { exec tail -3 LOGFILE_POST | head -1 } line
    set items [split $line]
    set delta [lindex $items 2]
    # The old value 0.0005409 is probably better.
    # We need to fix the shock-fitting that is currently producing
    # (1) a 'stiff' final bit of shock toward the axis and
    # (2) a wobbly final bit of shock far from the body.
    # PJ 2019-11-09
    expr abs($delta - 0.0005426) < 3.0e-6
} -result {1}

cleanupTests
